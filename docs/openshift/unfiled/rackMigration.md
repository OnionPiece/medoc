# OpenShift 集群节点机架迁移规范

## 背景

业务需求，需要把当前集群的所有服务器迁移到别的机架/机房。并且已确认不同机位下的网络环境、服务器IP等可以保持不变。

## 非高可用架构迁移

集群在搭建时，因为条件受限，并没有做到完全的高可用。只有Master节点是做了高可用的，而NFS，Harbor，Loadbalancer均为单点。

但迁移过程中，有额外的资源可以加入集群，完善集群的高可用。

### 节点迁移列表

需要迁移的节点清单如下:

    Master * 3
    Node 若干
    Loadbalancer * 1
    NFS * 1
    Harbor * 1
    
可扩展的节点（备机）清单:
 
     Loadbalancer * 1
     NFS * 1
     Harbor * 1
 
扩展后，即完成了Loadbalancer，NFS，Harbor的高可用。

**注意: 实际情况中，NFS和Harbor服务可能运行在同一个节点，因此后边的迁移步骤中可以将针对它们的操作放在一起进行。**

### 迁移步骤
 
建议的步骤如下，可根据实际情况做出调节。但原则上，应该有限考虑迁移存储节点，并且当存储稳定后，在进行后续的迁移。 

#### 迁移 NFS

说明: 以下主机（即当前的NFS节点）与备机（即扩容进来的NFS节点）的主备关系描述为迁移前的，而与迁移后，主备关系发生切换无关。

    a. 迁移备机，启动备机，并在备机上完成相关服务的安装与配置；
    b. 在备机上启动NFS服务并完成数据同步；
    c. 从集群内的节点上测试备机上的NFS服务可访问；
    d. 确认备机上的keepalived停用，修改配置，修改state为MASTER，VIP是当前OpenShift所使用的存储IP；
    e. 如果主机上只有一个IP（即上一步骤中的VIP），那么需要确保IPMI可用，或者添加其他IP来确保主机可管。确认后，从主机上删
       除VIP，同时立即启动备机的keepalived，保证VIP在备机上被挂起来；
    f. 进行数据读写测试并观察一段时间，以确保备机工作正常，否则需要将VIP切回主机，避免存储服务不可用；
    g. 在迁移主机前，为主机重新分配IP，或者修改网络配置，使用其他合法可用的IP作为静态地址，以避免迁移启动后，IP地址冲突；
    h. 迁移主机，启动后，修改keepalived的配置，修改state为BACKUP，并确认VIP；
    i. 启动主机的NFS、keepalived服务；
    j. 配置两个NFS节点的数据周期同步。

#### 迁移 Harbor

基本步骤可参考前面的 迁移NFS ，其中:

    a. 备机上keepalived中配置的VIP为当前OpenShift所使用的harbor IP；
    b. 备机上启动keepalived，挂起VIP后，建议进行镜像推拉的测试；

#### 迁移 Loadbalancer

说明: 以下主机（即当前的Loadbalancer节点）与备机（即扩容进来的Loadbalancer节点）的主备关系描述为迁移前的，而与迁移后，主备关系发生切换无关。

    a. 迁移备机，启动备机，安装相关服务并修改配置；
    b. 在备机上启动haproxy，修改hosts，对集群进行访问测试；
    c. 确认备机上的keepalived停用，修改配置，修改state为Master，VIP为主机的服务IP（即与集群域名做DNS映射的IP）；
    d. 如果主机上只有一个IP（即上一步骤中的VIP），那么需要确保IPMI可用，或者添加其他IP来确保主机可管。确认后，从主机上删
       除VIP，同时立即启动备机的keepalived，保证VIP在备机上被挂起来；
    e. 进行集群访问测试，确保切换稳定，否则需要将VIP切回主机；
    f.  在迁移主机前，为主机重新分配IP，或者修改网络配置，使用其他合法可用的IP作为静态地址，以避免迁移启动后，IP地址冲突；
    h. 迁移主机，启动后，修改keepalived的配置，修改state为BACKUP，并确认VIP；
    i. 启动主机的haproxy、keepalived服务。

#### 迁移 Master

因为Master做了高可用，所以可以认为迁移Master对用户没什么影响。对Master逐个进行迁移，迁移后，需要确认:

  - 负载均衡到Master的网络是通的；
  - Master的tun0到集群内其他节点的tun0的网络是通的；
  - 确认etcd集群正常。

#### 迁移 Node

为减小节点迁移对用户容器的影响，我们希望客户的容器至少存在一个副本是存在与已迁移或未迁移的节点上的，如果实际情况不是这样，则需要手动进行副本扩容。但也有例外，如用户的容器只能以单实例运行。

    a. 选出当前负载最小，即承载容器最少的节点；
    b. 确认节点上的容器的副本情况，并进行必要的副本扩容；
    c. 关闭当前节点的调度，并驱逐节点上的容器；
    d. 迁移节点 ，启动节点，通过底层docker命令测试节点能否创建容器；
    e. 启动origin-node服务，恢复节点的调度，针对该节点测试容器部署；
    f. 关闭所有未迁移节点的调度；
    h. 重复执行步骤a~e，直到所有节点完成迁移。

## 高可用架构迁移

### 需要迁移的节点

节点清单如下:

    Master * 3
    Node 若干
    Loadbalancer * 2
    NFS * 2
    Harbor * 2

**注: Loadbalancer, NFS, Harbor采用主备高**

**注: 实际情况中，NFS和Harbor服务可能运行在同一个节点，因此后边的迁移步骤中可以将针对它们的操作放在一起进行。**

## 迁移步骤

基本上参考非高可用架构的迁移步骤。

因为NFS，Harbor，Loadbalancer已经具有了高可用，因此实际操作中，更多是在进行人工干预下的主备切换。即

    a. 迁移备机，启动服务；
    b. 完成主备间的数据同步；
    c. 修改备机上keepalived的配置，state变为MASTER；
    d. 修改主机上keepalived的配置，state变为BACKUP；
    e. 停用主机上的keepalived，确认VIP从主机上移除；
    f. 重启备机上的keepalived，确认VIP在备机上挂起；
    g. 迁移主机，启动服务。
    
而迁移Master，Node等与非高可用架构的迁移步骤一致。
